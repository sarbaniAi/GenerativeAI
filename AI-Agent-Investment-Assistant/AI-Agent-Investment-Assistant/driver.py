# Databricks notebook source
# MAGIC %md
# MAGIC # Driver notebook
# MAGIC
# MAGIC This is an auto-generated notebook created by an AI Playground export. We generated three notebooks in the same folder:
# MAGIC - [agent]($./agent): contains the code to build the agent.
# MAGIC - [config.yml]($./config.yml): contains the configurations.
# MAGIC - [**driver**]($./driver): logs, evaluate, registers, and deploys the agent.
# MAGIC
# MAGIC This notebook uses Mosaic AI Agent Framework ([AWS](https://docs.databricks.com/en/generative-ai/retrieval-augmented-generation.html) | [Azure](https://learn.microsoft.com/en-us/azure/databricks/generative-ai/retrieval-augmented-generation)) to deploy the agent defined in the [agent]($./agent) notebook. The notebook does the following:
# MAGIC 1. Logs the agent to MLflow
# MAGIC 2. Evaluate the agent with Agent Evaluation
# MAGIC 3. Registers the agent to Unity Catalog
# MAGIC 4. Deploys the agent to a Model Serving endpoint
# MAGIC
# MAGIC ## Prerequisities
# MAGIC
# MAGIC - Address all `TODO`s in this notebook.
# MAGIC - Review the contents of [config.yml]($./config.yml) as it defines the tools available to your agent, the LLM endpoint, and the agent prompt.
# MAGIC - Review and run the [agent]($./agent) notebook in this folder to view the agent's code, iterate on the code, and test outputs.
# MAGIC
# MAGIC ## Next steps
# MAGIC
# MAGIC After your agent is deployed, you can chat with it in AI playground to perform additional checks, share it with SMEs in your organization for feedback, or embed it in a production application. See docs ([AWS](https://docs.databricks.com/en/generative-ai/deploy-agent.html) | [Azure](https://learn.microsoft.com/en-us/azure/databricks/generative-ai/deploy-agent)) for details

# COMMAND ----------

# MAGIC %pip install -U -qqqq databricks-agents mlflow langchain==0.2.16 langgraph-checkpoint==1.0.12  langchain_core langchain-community==0.2.16 langgraph==0.2.16 pydantic databricks_langchain
# MAGIC dbutils.library.restartPython()

# COMMAND ----------

# MAGIC %md
# MAGIC ### Log the `agent` as an MLflow model
# MAGIC Log the agent as code from the [agent]($./agent) notebook. See [MLflow - Models from Code](https://mlflow.org/docs/latest/models.html#models-from-code).

# COMMAND ----------

# Log the model to MLflow
import os
import mlflow

input_example = {
    "messages": [
        {
            "role": "user",
            "content": "how can you assist?"
        }
    ]
}

with mlflow.start_run():
    logged_agent_info = mlflow.langchain.log_model(
        lc_model=os.path.join(
            os.getcwd(),
            'agent',
        ),
        pip_requirements=[
            "langchain==0.2.16",
            "langchain-community==0.2.16",
            "langgraph-checkpoint==1.0.12",
            "langgraph==0.2.16",
            "pydantic",
            "databricks_langchain", # used for the retriever tool
        ],
        model_config="config.yml",
        artifact_path='agent',
        input_example=input_example,
    )

# COMMAND ----------

# MAGIC %md
# MAGIC ## Evaluate the agent with [Agent Evaluation](https://docs.databricks.com/generative-ai/agent-evaluation/index.html)
# MAGIC
# MAGIC You can edit the requests or expected responses in your evaluation dataset and run evaluation as you iterate your agent, leveraging mlflow to track the computed quality metrics.

# COMMAND ----------

import pandas as pd

eval_examples = [
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                }
            ]
        },
        "expected_response": None
    },
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                },
                {
                    "role": "assistant",
                    "content": "I can assist you with investment recommendations by analyzing specific stocks. If you provide me with a company name or stock ticker symbol, I can:\n\n1. Retrieve the stock ticker symbol if it's not provided.\n2. Analyze the stock using various tools to get the current market price, financial insights, and historical data.\n3. Provide a recommendation (Buy, Hold, or Sell) based on the analysis.\n4. Tailor the recommendation to specific customer preferences if a customer ID is provided.\n\nLet me know how I can assist you further!"
                },
                {
                    "role": "user",
                    "content": "list the tools you have access?"
                }
            ]
        },
        "expected_response": None
    },
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                },
                {
                    "role": "assistant",
                    "content": "I can assist you with investment recommendations by analyzing specific stocks. If you provide me with a company name or stock ticker symbol, I can:\n\n1. Retrieve the stock ticker symbol if it's not provided.\n2. Analyze the stock using various tools to get the current market price, financial insights, and historical data.\n3. Provide a recommendation (Buy, Hold, or Sell) based on the analysis.\n4. Tailor the recommendation to specific customer preferences if a customer ID is provided.\n\nLet me know how I can assist you further!"
                },
                {
                    "role": "user",
                    "content": "list the tools you have access?"
                },
                {
                    "role": "assistant",
                    "content": "I have access to the following tools to assist with investment analysis:\n\n1. **Customer Investment Preferences**: This tool helps retrieve a customer's risk appetite and other investment preferences based on their customer ID.\n\n2. **Finance Stock Quote**: This tool provides the current stock market price for a given stock ticker.\n\n3. **Finance Insight API**: This tool offers financial summaries and insights for a specified stock ticker.\n\n4. **Get Historical Closing Price**: This tool extracts historical stock volume and closing prices for a specified stock over a given duration.\n\nThese tools allow me to gather comprehensive information to provide well-informed investment recommendations. Let me know if you need assistance with a specific stock or customer!"
                },
                {
                    "role": "user",
                    "content": "should I invest in tesla stock for customer id 1264?"
                }
            ]
        },
        "expected_response": None
    },
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                },
                {
                    "role": "assistant",
                    "content": "I can assist you with investment recommendations by analyzing specific stocks. If you provide me with a company name or stock ticker symbol, I can:\n\n1. Retrieve the stock ticker symbol if it's not provided.\n2. Analyze the stock using various tools to get the current market price, financial insights, and historical data.\n3. Provide a recommendation (Buy, Hold, or Sell) based on the analysis.\n4. Tailor the recommendation to specific customer preferences if a customer ID is provided.\n\nLet me know how I can assist you further!"
                },
                {
                    "role": "user",
                    "content": "list the tools you have access?"
                },
                {
                    "role": "assistant",
                    "content": "I have access to the following tools to assist with investment analysis:\n\n1. **Customer Investment Preferences**: This tool helps retrieve a customer's risk appetite and other investment preferences based on their customer ID.\n\n2. **Finance Stock Quote**: This tool provides the current stock market price for a given stock ticker.\n\n3. **Finance Insight API**: This tool offers financial summaries and insights for a specified stock ticker.\n\n4. **Get Historical Closing Price**: This tool extracts historical stock volume and closing prices for a specified stock over a given duration.\n\nThese tools allow me to gather comprehensive information to provide well-informed investment recommendations. Let me know if you need assistance with a specific stock or customer!"
                },
                {
                    "role": "user",
                    "content": "should I invest in tesla stock for customer id 1264?"
                },
                {
                    "role": "assistant",
                    "content": "To analyze the historical stock volume and closing price of Tesla over the last year, which will provide context for the stock's performance and volatility.\n\n<uc_function_call>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"name\":\"sarbanimaiti_catalog.agent_demo.get_hist_closing_price\",\"arguments\":\"{\\\"stock_ticker\\\":\\\"TSLA\\\",\\\"yr_duration\\\":1}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"Date\\\",\\\"Close\\\",\\\"Volume\\\"],\\\"rows\\\":[[\\\"2024-01-04\\\",237.93,102629300],[\\\"2024-01-05\\\",237.49,92379400],[\\\"2024-01-08\\\",240.45,85166600],[\\\"2024-01-09\\\",234.96,96705700],[\\\"2024-01-10\\\",233.94,91628500],[\\\"2024-01-11\\\",227.22,105873600],[\\\"2024-01-12\\\",218.89,122889000],[\\\"2024-01-16\\\",219.91,115355000],[\\\"2024-01-17\\\",215.55,103164400],[\\\"2024-01-18\\\",211.88,108595400],[\\\"2024-01-19\\\",212.19,102095800],[\\\"2024-01-22\\\",208.8,117952500],[\\\"2024-01-23\\\",209.14,106605900],[\\\"2024-01-24\\\",207.83,123369900],[\\\"2024-01-25\\\",182.63,198076800],[\\\"2024-01-26\\\",183.25,107343200],[\\\"2024-01-29\\\",190.93,125013100],[\\\"2024-01-30\\\",191.59,109982300]]}\"}</uc_function_result>\n\nTo gather financial insights and summaries about Tesla stock, which will aid in making a comprehensive investment recommendation.\n\n<uc_function_call>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_insight_api\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"['Tesla Inc. manufactures and sells electric vehicles, and energy generation and storage systems. The company was founded in 2003 and went public in June 2010 with an initial public offering at $17 per share. Tesla has approximately 49,000 employees. It recently moved its headquarters to Austin, Texas from Palo Alto, California.']\\\"]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_stock_quote\n\n<uc_function_call>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_stock_quote\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"{'quoteResponse': {'result': [{'language': 'en-US', 'region': 'US', 'quoteType': 'EQUITY', 'typeDisp': 'Equity', 'quoteSourceName': 'Nasdaq Real Time Price', 'triggerable': True, 'customPriceAlertConfidence': 'HIGH', 'currency': 'USD', 'regularMarketChangePercent': -1.0180622, 'regularMarketPrice': 374.32, 'marketState': 'PRE', 'corporateActions': [], 'preMarketTime': 1738925454, 'regularMarketTime': 1738875600, 'exchange': 'NMS', 'messageBoardId': 'finmb_27444752', 'exchangeTimezoneName': 'America/New_York', 'exchangeTimezoneShortName': 'EST', 'gmtOffSetMilliseconds': -18000000, 'market': 'us_market', 'esgPopulated': False, 'shortName': 'Tesla, Inc.', 'longName': 'Tesla, Inc.', 'hasPrePostMarketData': True, 'firstTradeDateMilliseconds': 1277818200000, 'priceHint': 2, 'preMarketChange': -5.9200134, 'preMarketChangePercent': -1.5815381, 'preMarketPrice': 368.4, 'regularMarketChange': -3.850006, 'regularMarketDayHigh': 375.4, 'regularMarketDayRange': '363.18 - 375.4', 'regularMarketDayLow': 363.18, 'regularMarketVolume': 77146551, 'regularMarketPreviousClose': 378.17, 'bid': 374.08, 'ask': 374.08, 'bidSize': 2, 'askSize': 1, 'fullExchangeName': 'NasdaqGS', 'financialCurrency': 'USD', 'regularMarketOpen': 373.105, 'averageDailyVolume3Month': 88742310, 'averageDailyVolume10Day': 67187620, 'fiftyTwoWeekLowChange': 235.52, 'fiftyTwoWeekLowChangePercent': 1.6968299, 'fiftyTwoWeekRange': '138.8 - 488.54', 'fiftyTwoWeekHighChange': -114.22, 'fiftyTwoWeekHighChangePercent': -0.23379867, 'fiftyTwoWeekLow': 138.8, 'fiftyTwoWeekHigh': 488.54, 'fiftyTwoWeekChangePercent': 95.36601, 'earningsTimestamp': 1738184940, 'earningsTimestampStart': 1745438400, 'earningsTimestampEnd': 1746302400, 'earningsCallTimestampStart': 1738189800, 'earningsCallTimestampEnd': 1738189800, 'isEarningsDateEstimate': True, 'trailingAnnualDividendRate': 0.0, 'trailingPE': 185.30693, 'trailingAnnualDividendYield': 0.0, 'epsTrailingTwelveMonths': 2.02, 'epsForward': 3.24, 'epsCurrentYear': 2.93627, 'priceEpsCurrentYear': 127.48147, 'sharesOutstanding': 3216519936, 'bookValue': 21.806, 'fiftyDayAverage': 400.734, 'fiftyDayAverageChange': -26.414001, 'fiftyDayAverageChangePercent': -0.06591405, 'twoHundredDayAverage': 265.57034, 'twoHundredDayAverageChange': 108.749664, 'twoHundredDayAverageChangePercent': 0.40949476, 'marketCap': 1204007731200, 'forwardPE': 115.53087, 'priceToBook': 17.165918, 'sourceInterval': 15, 'exchangeDataDelayedBy': 0, 'averageAnalystRating': '2.8 - Hold', 'tradeable': False, 'cryptoTradeable': False, 'displayName': 'Tesla', 'symbol': 'TSLA'}], 'error': None}}\\\"]]}\"}</uc_function_result>\n\nI need to understand the specific investment preferences and risk appetite of customer ID 1264 to tailor the investment recommendation for Tesla stock.\n\n<uc_function_call>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"name\":\"sarbanimaiti_catalog.agent_demo.cust_investment_pref\",\"arguments\":\"{\\\"customerID\\\":1264}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"customer_id\\\",\\\"age\\\",\\\"gender\\\",\\\"income_range\\\",\\\"risk_tolerance\\\",\\\"investment_horizon\\\",\\\"investment_goals\\\",\\\"preferred_industries\\\",\\\"preferred_stock_types\\\",\\\"average_investment_amount\\\",\\\"trading_frequency\\\",\\\"holding_period\\\",\\\"historical_performance\\\",\\\"special_requirements\\\"],\\\"rows\\\":[[1264,41,\\\"Female\\\",\\\"low\\\",\\\"high\\\",\\\"long-term\\\",\\\"savings\\\",\\\"['healthcare']\\\",\\\"dividend\\\",5575.91,None,None,None,None]]}\"}</uc_function_result>\n\n**Hold**\n\nBased on the analysis of Tesla (TSLA) stock and the investment preferences of customer ID 1264, here's the detailed recommendation:\n\n1. **Current Market Price**: Tesla's current market price is $374.32, with a recent decline of about 1.02%. The stock has experienced a 52-week range between $138.8 and $488.54, indicating significant volatility.\n\n2. **Financial Insights**: Tesla is a leading manufacturer of electric vehicles and energy solutions. The company has a high market capitalization of approximately $1.2 trillion, with a trailing PE ratio of 185.31, which suggests that the stock is currently trading at a high valuation relative to its earnings.\n\n3. **Historical Performance**: Over the past year, Tesla's stock has shown considerable fluctuations, with a notable drop in January 2024. The average daily volume over the last three months is 88,742,310, indicating strong trading activity.\n\n4. **Customer Preferences**: Customer ID 1264 has a high-risk tolerance and a long-term investment horizon, with a preference for dividend stocks in the healthcare industry. While Tesla does not pay dividends and is not in the healthcare sector, its growth potential may align with the customer's high-risk tolerance.\n\nGiven the high valuation and recent market performance, along with the customer's preference for dividend stocks, a \"Hold\" recommendation is appropriate. This allows for monitoring Tesla's performance and market conditions, especially considering the customer's long-term investment horizon."
                },
                {
                    "role": "user",
                    "content": "should I invest in amazon stocks for customer id 6745?"
                }
            ]
        },
        "expected_response": None
    },
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                },
                {
                    "role": "assistant",
                    "content": "I can assist you with investment recommendations by analyzing specific stocks. If you provide me with a company name or stock ticker symbol, I can:\n\n1. Retrieve the stock ticker symbol if it's not provided.\n2. Analyze the stock using various tools to get the current market price, financial insights, and historical data.\n3. Provide a recommendation (Buy, Hold, or Sell) based on the analysis.\n4. Tailor the recommendation to specific customer preferences if a customer ID is provided.\n\nLet me know how I can assist you further!"
                },
                {
                    "role": "user",
                    "content": "list the tools you have access?"
                },
                {
                    "role": "assistant",
                    "content": "I have access to the following tools to assist with investment analysis:\n\n1. **Customer Investment Preferences**: This tool helps retrieve a customer's risk appetite and other investment preferences based on their customer ID.\n\n2. **Finance Stock Quote**: This tool provides the current stock market price for a given stock ticker.\n\n3. **Finance Insight API**: This tool offers financial summaries and insights for a specified stock ticker.\n\n4. **Get Historical Closing Price**: This tool extracts historical stock volume and closing prices for a specified stock over a given duration.\n\nThese tools allow me to gather comprehensive information to provide well-informed investment recommendations. Let me know if you need assistance with a specific stock or customer!"
                },
                {
                    "role": "user",
                    "content": "should I invest in tesla stock for customer id 1264?"
                },
                {
                    "role": "assistant",
                    "content": "To analyze the historical stock volume and closing price of Tesla over the last year, which will provide context for the stock's performance and volatility.\n\n<uc_function_call>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"name\":\"sarbanimaiti_catalog.agent_demo.get_hist_closing_price\",\"arguments\":\"{\\\"stock_ticker\\\":\\\"TSLA\\\",\\\"yr_duration\\\":1}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"Date\\\",\\\"Close\\\",\\\"Volume\\\"],\\\"rows\\\":[[\\\"2024-01-04\\\",237.93,102629300],[\\\"2024-01-05\\\",237.49,92379400],[\\\"2024-01-08\\\",240.45,85166600],[\\\"2024-01-09\\\",234.96,96705700],[\\\"2024-01-10\\\",233.94,91628500],[\\\"2024-01-11\\\",227.22,105873600],[\\\"2024-01-12\\\",218.89,122889000],[\\\"2024-01-16\\\",219.91,115355000],[\\\"2024-01-17\\\",215.55,103164400],[\\\"2024-01-18\\\",211.88,108595400],[\\\"2024-01-19\\\",212.19,102095800],[\\\"2024-01-22\\\",208.8,117952500],[\\\"2024-01-23\\\",209.14,106605900],[\\\"2024-01-24\\\",207.83,123369900],[\\\"2024-01-25\\\",182.63,198076800],[\\\"2024-01-26\\\",183.25,107343200],[\\\"2024-01-29\\\",190.93,125013100],[\\\"2024-01-30\\\",191.59,109982300]]}\"}</uc_function_result>\n\nTo gather financial insights and summaries about Tesla stock, which will aid in making a comprehensive investment recommendation.\n\n<uc_function_call>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_insight_api\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"['Tesla Inc. manufactures and sells electric vehicles, and energy generation and storage systems. The company was founded in 2003 and went public in June 2010 with an initial public offering at $17 per share. Tesla has approximately 49,000 employees. It recently moved its headquarters to Austin, Texas from Palo Alto, California.']\\\"]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_stock_quote\n\n<uc_function_call>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_stock_quote\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"{'quoteResponse': {'result': [{'language': 'en-US', 'region': 'US', 'quoteType': 'EQUITY', 'typeDisp': 'Equity', 'quoteSourceName': 'Nasdaq Real Time Price', 'triggerable': True, 'customPriceAlertConfidence': 'HIGH', 'currency': 'USD', 'regularMarketChangePercent': -1.0180622, 'regularMarketPrice': 374.32, 'marketState': 'PRE', 'corporateActions': [], 'preMarketTime': 1738925454, 'regularMarketTime': 1738875600, 'exchange': 'NMS', 'messageBoardId': 'finmb_27444752', 'exchangeTimezoneName': 'America/New_York', 'exchangeTimezoneShortName': 'EST', 'gmtOffSetMilliseconds': -18000000, 'market': 'us_market', 'esgPopulated': False, 'shortName': 'Tesla, Inc.', 'longName': 'Tesla, Inc.', 'hasPrePostMarketData': True, 'firstTradeDateMilliseconds': 1277818200000, 'priceHint': 2, 'preMarketChange': -5.9200134, 'preMarketChangePercent': -1.5815381, 'preMarketPrice': 368.4, 'regularMarketChange': -3.850006, 'regularMarketDayHigh': 375.4, 'regularMarketDayRange': '363.18 - 375.4', 'regularMarketDayLow': 363.18, 'regularMarketVolume': 77146551, 'regularMarketPreviousClose': 378.17, 'bid': 374.08, 'ask': 374.08, 'bidSize': 2, 'askSize': 1, 'fullExchangeName': 'NasdaqGS', 'financialCurrency': 'USD', 'regularMarketOpen': 373.105, 'averageDailyVolume3Month': 88742310, 'averageDailyVolume10Day': 67187620, 'fiftyTwoWeekLowChange': 235.52, 'fiftyTwoWeekLowChangePercent': 1.6968299, 'fiftyTwoWeekRange': '138.8 - 488.54', 'fiftyTwoWeekHighChange': -114.22, 'fiftyTwoWeekHighChangePercent': -0.23379867, 'fiftyTwoWeekLow': 138.8, 'fiftyTwoWeekHigh': 488.54, 'fiftyTwoWeekChangePercent': 95.36601, 'earningsTimestamp': 1738184940, 'earningsTimestampStart': 1745438400, 'earningsTimestampEnd': 1746302400, 'earningsCallTimestampStart': 1738189800, 'earningsCallTimestampEnd': 1738189800, 'isEarningsDateEstimate': True, 'trailingAnnualDividendRate': 0.0, 'trailingPE': 185.30693, 'trailingAnnualDividendYield': 0.0, 'epsTrailingTwelveMonths': 2.02, 'epsForward': 3.24, 'epsCurrentYear': 2.93627, 'priceEpsCurrentYear': 127.48147, 'sharesOutstanding': 3216519936, 'bookValue': 21.806, 'fiftyDayAverage': 400.734, 'fiftyDayAverageChange': -26.414001, 'fiftyDayAverageChangePercent': -0.06591405, 'twoHundredDayAverage': 265.57034, 'twoHundredDayAverageChange': 108.749664, 'twoHundredDayAverageChangePercent': 0.40949476, 'marketCap': 1204007731200, 'forwardPE': 115.53087, 'priceToBook': 17.165918, 'sourceInterval': 15, 'exchangeDataDelayedBy': 0, 'averageAnalystRating': '2.8 - Hold', 'tradeable': False, 'cryptoTradeable': False, 'displayName': 'Tesla', 'symbol': 'TSLA'}], 'error': None}}\\\"]]}\"}</uc_function_result>\n\nI need to understand the specific investment preferences and risk appetite of customer ID 1264 to tailor the investment recommendation for Tesla stock.\n\n<uc_function_call>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"name\":\"sarbanimaiti_catalog.agent_demo.cust_investment_pref\",\"arguments\":\"{\\\"customerID\\\":1264}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"customer_id\\\",\\\"age\\\",\\\"gender\\\",\\\"income_range\\\",\\\"risk_tolerance\\\",\\\"investment_horizon\\\",\\\"investment_goals\\\",\\\"preferred_industries\\\",\\\"preferred_stock_types\\\",\\\"average_investment_amount\\\",\\\"trading_frequency\\\",\\\"holding_period\\\",\\\"historical_performance\\\",\\\"special_requirements\\\"],\\\"rows\\\":[[1264,41,\\\"Female\\\",\\\"low\\\",\\\"high\\\",\\\"long-term\\\",\\\"savings\\\",\\\"['healthcare']\\\",\\\"dividend\\\",5575.91,None,None,None,None]]}\"}</uc_function_result>\n\n**Hold**\n\nBased on the analysis of Tesla (TSLA) stock and the investment preferences of customer ID 1264, here's the detailed recommendation:\n\n1. **Current Market Price**: Tesla's current market price is $374.32, with a recent decline of about 1.02%. The stock has experienced a 52-week range between $138.8 and $488.54, indicating significant volatility.\n\n2. **Financial Insights**: Tesla is a leading manufacturer of electric vehicles and energy solutions. The company has a high market capitalization of approximately $1.2 trillion, with a trailing PE ratio of 185.31, which suggests that the stock is currently trading at a high valuation relative to its earnings.\n\n3. **Historical Performance**: Over the past year, Tesla's stock has shown considerable fluctuations, with a notable drop in January 2024. The average daily volume over the last three months is 88,742,310, indicating strong trading activity.\n\n4. **Customer Preferences**: Customer ID 1264 has a high-risk tolerance and a long-term investment horizon, with a preference for dividend stocks in the healthcare industry. While Tesla does not pay dividends and is not in the healthcare sector, its growth potential may align with the customer's high-risk tolerance.\n\nGiven the high valuation and recent market performance, along with the customer's preference for dividend stocks, a \"Hold\" recommendation is appropriate. This allows for monitoring Tesla's performance and market conditions, especially considering the customer's long-term investment horizon."
                },
                {
                    "role": "user",
                    "content": "should I invest in amazon stocks for customer id 6745?"
                },
                {
                    "role": "assistant",
                    "content": "I need to understand the specific investment preferences, risk tolerance, and other relevant details for customer ID 6745 to tailor the investment recommendation for Amazon stock accordingly.\n\n<uc_function_call>{\"id\":\"2Ii4Ge1Bpl7Phr1a1KMB\",\"name\":\"sarbanimaiti_catalog.agent_demo.cust_investment_pref\",\"arguments\":\"{\\\"customerID\\\":6745}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"2Ii4Ge1Bpl7Phr1a1KMB\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"customer_id\\\",\\\"age\\\",\\\"gender\\\",\\\"income_range\\\",\\\"risk_tolerance\\\",\\\"investment_horizon\\\",\\\"investment_goals\\\",\\\"preferred_industries\\\",\\\"preferred_stock_types\\\",\\\"average_investment_amount\\\",\\\"trading_frequency\\\",\\\"holding_period\\\",\\\"historical_performance\\\",\\\"special_requirements\\\"],\\\"rows\\\":[[6745,40,\\\"Female\\\",\\\"low\\\",\\\"high\\\",\\\"long-term\\\",\\\"savings\\\",\\\"['tech']\\\",\\\"blue-chip\\\",60018.1,None,None,None,None]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.get_hist_closing_price\n\n<uc_function_call>{\"id\":\"V7uprA79GK1CIlCadun6\",\"name\":\"sarbanimaiti_catalog.agent_demo.get_hist_closing_price\",\"arguments\":\"{\\\"stock_ticker\\\":\\\"AMZN\\\",\\\"yr_duration\\\":1}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"V7uprA79GK1CIlCadun6\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"Date\\\",\\\"Close\\\",\\\"Volume\\\"],\\\"rows\\\":[[\\\"2024-01-04\\\",144.57,56039800],[\\\"2024-01-05\\\",145.24,45124800],[\\\"2024-01-08\\\",149.1,46757100],[\\\"2024-01-09\\\",151.37,43812600],[\\\"2024-01-10\\\",153.73,44421800],[\\\"2024-01-11\\\",155.18,49072700],[\\\"2024-01-12\\\",154.62,40460300],[\\\"2024-01-16\\\",153.16,41384600],[\\\"2024-01-17\\\",151.71,34953400],[\\\"2024-01-18\\\",153.5,37850200],[\\\"2024-01-19\\\",155.34,51033700],[\\\"2024-01-22\\\",154.78,43687500],[\\\"2024-01-23\\\",156.02,37986000],[\\\"2024-01-24\\\",156.87,48547300],[\\\"2024-01-25\\\",157.75,43638600],[\\\"2024-01-26\\\",159.12,51047400],[\\\"2024-01-29\\\",161.26,45270400],[\\\"2024-01-30\\\",159.0,45207400]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_insight_api\n\n<uc_function_call>{\"id\":\"W0srfpMKpMNA7CEpCLhL\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_insight_api\",\"arguments\":\"{\\\"query\\\":\\\"AMZN\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"W0srfpMKpMNA7CEpCLhL\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"[\\\\\\\"Argus believes that 2025 may be defined by 10 investment themes. Throughout the year, we will take a deep dive into these themes, providing updates and giving stock picks on the prominent companies whose businesses play out in each theme. In many cases, we believe these thematic factors will supersede industry characteristics and drive performance. Our Investment Themes for 2025 are: Theme 1: Management Signals; Theme 2: Artificial Intelligence; Theme 3: Clean Energy; Theme 4: Sustainable Impact investing; Theme 5: Innovation; Theme 6: Cybersecurity; Theme 7: Investing in the Cloud; Theme 8: Aerospace and Defense, All Systems Go; Theme 9: Uptick in Capex amid Declining Interest Rates; and Theme 10: Pharmaceuticals and Biotechnology. For this week's Weekly List, we examine Theme 7: Investing in the Cloud. Cloud computing has transformed the technology landscape over the past decade. Created almost accidently as a means or organizing customer invoices, cloud has grown from the management of outsourced technology hardware resources to encompass tasks, up to and including software development, big data analytics, and artificial intelligence (AI). Indeed, following availability of ChatGPT in November 2022, awareness of generative AI hit the business community like an electric shock, and has completely upended IT spending plans for the next several years. Given that delivery of AI will mainly occur within a hybrid cloud environment, emergence of AI-as-a-service represents a difficult-to-quantify, but undoubtedly positive driver of cloud service revenues in the coming years. The leading providers of cloud services tend to be large technology and communications services companies that provide many goods and services distinct from or adjacent to their cloud businesses. These companies include Amazon.com, Microsoft, Alphabet, and others in the U.S., along with Alibaba, Baidu, Tencent, and others in China. Collectively, participants in the cloud eco-system grew revenue by a high-teens compound annual rate from 2016 to 2023. Revenue for cloud services has held up well, as cloud transition is a long-tailed process and cloud transformation has become an imperative. According to IDC, revenue in the industry grew 21% in 2024. Looking ahead, with inflation growth slowing and amid improving business and consumer confidence, both consumer device demand and enterprise IT spending should accelerate. We expect rising device demand and enterprise IT spending both domestically and internationally to drive cloud investment in 2025 and beyond. Some of the companies that should benefit in the space include the following.\\\\\\\"]\\\"]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_stock_quote\n\n<uc_function_call>{\"id\":\"4Kg901Z2kHoSJER737Lo\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_stock_quote\",\"arguments\":\"{\\\"query\\\":\\\"AMZN\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"4Kg901Z2kHoSJER737Lo\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"{'quoteResponse': {'result': [{'language': 'en-US', 'region': 'US', 'quoteType': 'EQUITY', 'typeDisp': 'Equity', 'quoteSourceName': 'Nasdaq Real Time Price', 'triggerable': True, 'customPriceAlertConfidence': 'HIGH', 'currency': 'USD', 'hasPrePostMarketData': True, 'firstTradeDateMilliseconds': 863703000000, 'priceHint': 2, 'preMarketChange': -7.0, 'preMarketChangePercent': -2.930955, 'preMarketPrice': 231.83, 'regularMarketChange': 2.6600037, 'regularMarketDayHigh': 239.6599, 'regularMarketDayRange': '236.01 - 239.6599', 'regularMarketDayLow': 236.01, 'regularMarketVolume': 51116670, 'regularMarketPreviousClose': 236.17, 'bid': 238.62, 'ask': 238.82, 'bidSize': 2, 'askSize': 1, 'fullExchangeName': 'NasdaqGS', 'financialCurrency': 'USD', 'regularMarketOpen': 238.268, 'averageDailyVolume3Month': 36123216, 'averageDailyVolume10Day': 34331240, 'fiftyTwoWeekLowChange': 87.22, 'fiftyTwoWeekLowChangePercent': 0.5752919, 'fiftyTwoWeekRange': '151.61 - 242.52', 'fiftyTwoWeekHighChange': -3.6900024, 'fiftyTwoWeekHighChangePercent': -0.01521525, 'fiftyTwoWeekLow': 151.61, 'fiftyTwoWeekHigh': 242.52, 'fiftyTwoWeekChangePercent': 35.37977, 'earningsTimestamp': 1738875600, 'earningsTimestampStart': 1745837940, 'earningsTimestampEnd': 1746187200, 'earningsCallTimestampStart': 1738879200, 'earningsCallTimestampEnd': 1738879200, 'isEarningsDateEstimate': True, 'trailingAnnualDividendRate': 0.0, 'trailingPE': 43.110107, 'trailingAnnualDividendYield': 0.0, 'epsTrailingTwelveMonths': 5.54, 'epsForward': 6.15, 'epsCurrentYear': 6.25204, 'priceEpsCurrentYear': 38.200333, 'sharesOutstanding': 10515000320, 'bookValue': 24.655, 'fiftyDayAverage': 224.0106, 'fiftyDayAverageChange': 14.819397, 'fiftyDayAverageChangePercent': 0.06615489, 'twoHundredDayAverage': 195.25694, 'twoHundredDayAverageChange': 43.57306, 'twoHundredDayAverageChangePercent': 0.22315754, 'marketCap': 2511297576960, 'forwardPE': 38.834145, 'priceToBook': 9.686879, 'sourceInterval': 15, 'exchangeDataDelayedBy': 0, 'averageAnalystRating': '1.4 - Strong Buy', 'tradeable': False, 'cryptoTradeable': False, 'marketState': 'PRE', 'shortName': 'Amazon.com, Inc.', 'longName': 'Amazon.com, Inc.', 'corporateActions': [], 'preMarketTime': 1738925598, 'regularMarketTime': 1738875601, 'exchange': 'NMS', 'messageBoardId': 'finmb_18749', 'exchangeTimezoneName': 'America/New_York', 'exchangeTimezoneShortName': 'EST', 'gmtOffSetMilliseconds': -18000000, 'market': 'us_market', 'esgPopulated': False, 'regularMarketChangePercent': 1.1263089, 'regularMarketPrice': 238.83, 'displayName': 'Amazon.com', 'symbol': 'AMZN'}], 'error': None}}\\\"]]}\"}</uc_function_result>\n\n**Buy**\n\nBased on the analysis of Amazon (AMZN) stock and the investment preferences of customer ID 6745, here's the detailed recommendation:\n\n1. **Current Market Price**: Amazon's current market price is $238.83, with a recent increase of about 1.13%. The stock has experienced a 52-week range between $151.61 and $242.52, showing a strong upward trend with a 35.38% increase over the year.\n\n2. **Financial Insights**: Amazon is a leading player in the tech industry, particularly in cloud computing, which is expected to drive growth in the coming years. The company has a market capitalization of approximately $2.51 trillion, with a trailing PE ratio of 43.11, indicating a reasonable valuation for a tech giant.\n\n3. **Historical Performance**: Over the past year, Amazon's stock has shown consistent growth, with a strong performance in the tech sector. The average daily volume over the last three months is 36,123,216, reflecting robust trading activity.\n\n4. **Customer Preferences**: Customer ID 6745 has a high-risk tolerance and a long-term investment horizon, with a preference for blue-chip stocks in the tech industry. Amazon fits well within these preferences, offering growth potential and stability as a leading tech company.\n\nGiven the strong market position, growth prospects in cloud computing, and alignment with the customer's investment preferences, a \"Buy\" recommendation is appropriate. This allows the customer to capitalize on Amazon's growth potential in the tech sector, particularly in cloud services and AI."
                },
                {
                    "role": "user",
                    "content": "What are the current market price, market capitalization, and recent performance of Amazon stock?"
                }
            ]
        },
        "expected_response": None
    },
    {
        "request": {
            "messages": [
                {
                    "role": "system",
                    "content": "Follow each instruction carefully and step by step. You are a helpful investment assistant with the ability to identify company names and customer IDs only when explicitly provided. \n1) To get the stock ticker symbol -> Retrieve it only from the internet if it is not already provided by the user.\n2) For investment recommendations -> Once the ticker symbol is obtained, use the tools available to analyze the stock and determine the recommendation for the specific customer id. Follow these steps in order ->\n    * Use  customer_investment_preferences to get the customer risk appetite and other preferences for the given customer id.\n    * If customer id is not mentioned give your generic recomenddation based on the stock analysis done using the below tools.\n    * Use finance_stock_quote to get the current stock market price for the given stock .\n    * Use finance_insight_api to get the stock summary/insights for the given stock .\n    * Use get_historical_closing_price for the last year to extract historical stock volume and closing price of the specified stock .\n    *\n    * Once you get response from all the above tools STOP calling tools and generate the final response as given in the Output Format.\n    * Output Format:Begin the response with either Bolded Buy, Hold, or Sell as your recommendation. Follow up with detailed justification, using specific numbers and insights from the tools. Avoid assuming or fabricating customer IDs or other missing information.\nIMPORTANT -> If any required data is unavailable from the tools, state explicitly which data is missing and proceed with the recommendation based on the information you do have. "
                },
                {
                    "role": "user",
                    "content": "how can you assist?"
                },
                {
                    "role": "assistant",
                    "content": "I can assist you with investment recommendations by analyzing specific stocks. If you provide me with a company name or stock ticker symbol, I can:\n\n1. Retrieve the stock ticker symbol if it's not provided.\n2. Analyze the stock using various tools to get the current market price, financial insights, and historical data.\n3. Provide a recommendation (Buy, Hold, or Sell) based on the analysis.\n4. Tailor the recommendation to specific customer preferences if a customer ID is provided.\n\nLet me know how I can assist you further!"
                },
                {
                    "role": "user",
                    "content": "list the tools you have access?"
                },
                {
                    "role": "assistant",
                    "content": "I have access to the following tools to assist with investment analysis:\n\n1. **Customer Investment Preferences**: This tool helps retrieve a customer's risk appetite and other investment preferences based on their customer ID.\n\n2. **Finance Stock Quote**: This tool provides the current stock market price for a given stock ticker.\n\n3. **Finance Insight API**: This tool offers financial summaries and insights for a specified stock ticker.\n\n4. **Get Historical Closing Price**: This tool extracts historical stock volume and closing prices for a specified stock over a given duration.\n\nThese tools allow me to gather comprehensive information to provide well-informed investment recommendations. Let me know if you need assistance with a specific stock or customer!"
                },
                {
                    "role": "user",
                    "content": "should I invest in tesla stock for customer id 1264?"
                },
                {
                    "role": "assistant",
                    "content": "To analyze the historical stock volume and closing price of Tesla over the last year, which will provide context for the stock's performance and volatility.\n\n<uc_function_call>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"name\":\"sarbanimaiti_catalog.agent_demo.get_hist_closing_price\",\"arguments\":\"{\\\"stock_ticker\\\":\\\"TSLA\\\",\\\"yr_duration\\\":1}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"dPz2NtgozfiTIl7nP4tm\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"Date\\\",\\\"Close\\\",\\\"Volume\\\"],\\\"rows\\\":[[\\\"2024-01-04\\\",237.93,102629300],[\\\"2024-01-05\\\",237.49,92379400],[\\\"2024-01-08\\\",240.45,85166600],[\\\"2024-01-09\\\",234.96,96705700],[\\\"2024-01-10\\\",233.94,91628500],[\\\"2024-01-11\\\",227.22,105873600],[\\\"2024-01-12\\\",218.89,122889000],[\\\"2024-01-16\\\",219.91,115355000],[\\\"2024-01-17\\\",215.55,103164400],[\\\"2024-01-18\\\",211.88,108595400],[\\\"2024-01-19\\\",212.19,102095800],[\\\"2024-01-22\\\",208.8,117952500],[\\\"2024-01-23\\\",209.14,106605900],[\\\"2024-01-24\\\",207.83,123369900],[\\\"2024-01-25\\\",182.63,198076800],[\\\"2024-01-26\\\",183.25,107343200],[\\\"2024-01-29\\\",190.93,125013100],[\\\"2024-01-30\\\",191.59,109982300]]}\"}</uc_function_result>\n\nTo gather financial insights and summaries about Tesla stock, which will aid in making a comprehensive investment recommendation.\n\n<uc_function_call>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_insight_api\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"Wy6nIREtVQskJlDi6hNM\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"['Tesla Inc. manufactures and sells electric vehicles, and energy generation and storage systems. The company was founded in 2003 and went public in June 2010 with an initial public offering at $17 per share. Tesla has approximately 49,000 employees. It recently moved its headquarters to Austin, Texas from Palo Alto, California.']\\\"]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_stock_quote\n\n<uc_function_call>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_stock_quote\",\"arguments\":\"{\\\"query\\\":\\\"TSLA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"TKJlHDNbUlmaRJGkby6e\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"{'quoteResponse': {'result': [{'language': 'en-US', 'region': 'US', 'quoteType': 'EQUITY', 'typeDisp': 'Equity', 'quoteSourceName': 'Nasdaq Real Time Price', 'triggerable': True, 'customPriceAlertConfidence': 'HIGH', 'currency': 'USD', 'regularMarketChangePercent': -1.0180622, 'regularMarketPrice': 374.32, 'marketState': 'PRE', 'corporateActions': [], 'preMarketTime': 1738925454, 'regularMarketTime': 1738875600, 'exchange': 'NMS', 'messageBoardId': 'finmb_27444752', 'exchangeTimezoneName': 'America/New_York', 'exchangeTimezoneShortName': 'EST', 'gmtOffSetMilliseconds': -18000000, 'market': 'us_market', 'esgPopulated': False, 'shortName': 'Tesla, Inc.', 'longName': 'Tesla, Inc.', 'hasPrePostMarketData': True, 'firstTradeDateMilliseconds': 1277818200000, 'priceHint': 2, 'preMarketChange': -5.9200134, 'preMarketChangePercent': -1.5815381, 'preMarketPrice': 368.4, 'regularMarketChange': -3.850006, 'regularMarketDayHigh': 375.4, 'regularMarketDayRange': '363.18 - 375.4', 'regularMarketDayLow': 363.18, 'regularMarketVolume': 77146551, 'regularMarketPreviousClose': 378.17, 'bid': 374.08, 'ask': 374.08, 'bidSize': 2, 'askSize': 1, 'fullExchangeName': 'NasdaqGS', 'financialCurrency': 'USD', 'regularMarketOpen': 373.105, 'averageDailyVolume3Month': 88742310, 'averageDailyVolume10Day': 67187620, 'fiftyTwoWeekLowChange': 235.52, 'fiftyTwoWeekLowChangePercent': 1.6968299, 'fiftyTwoWeekRange': '138.8 - 488.54', 'fiftyTwoWeekHighChange': -114.22, 'fiftyTwoWeekHighChangePercent': -0.23379867, 'fiftyTwoWeekLow': 138.8, 'fiftyTwoWeekHigh': 488.54, 'fiftyTwoWeekChangePercent': 95.36601, 'earningsTimestamp': 1738184940, 'earningsTimestampStart': 1745438400, 'earningsTimestampEnd': 1746302400, 'earningsCallTimestampStart': 1738189800, 'earningsCallTimestampEnd': 1738189800, 'isEarningsDateEstimate': True, 'trailingAnnualDividendRate': 0.0, 'trailingPE': 185.30693, 'trailingAnnualDividendYield': 0.0, 'epsTrailingTwelveMonths': 2.02, 'epsForward': 3.24, 'epsCurrentYear': 2.93627, 'priceEpsCurrentYear': 127.48147, 'sharesOutstanding': 3216519936, 'bookValue': 21.806, 'fiftyDayAverage': 400.734, 'fiftyDayAverageChange': -26.414001, 'fiftyDayAverageChangePercent': -0.06591405, 'twoHundredDayAverage': 265.57034, 'twoHundredDayAverageChange': 108.749664, 'twoHundredDayAverageChangePercent': 0.40949476, 'marketCap': 1204007731200, 'forwardPE': 115.53087, 'priceToBook': 17.165918, 'sourceInterval': 15, 'exchangeDataDelayedBy': 0, 'averageAnalystRating': '2.8 - Hold', 'tradeable': False, 'cryptoTradeable': False, 'displayName': 'Tesla', 'symbol': 'TSLA'}], 'error': None}}\\\"]]}\"}</uc_function_result>\n\nI need to understand the specific investment preferences and risk appetite of customer ID 1264 to tailor the investment recommendation for Tesla stock.\n\n<uc_function_call>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"name\":\"sarbanimaiti_catalog.agent_demo.cust_investment_pref\",\"arguments\":\"{\\\"customerID\\\":1264}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"XLP4IqruMiroeEjuD6Mk\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"customer_id\\\",\\\"age\\\",\\\"gender\\\",\\\"income_range\\\",\\\"risk_tolerance\\\",\\\"investment_horizon\\\",\\\"investment_goals\\\",\\\"preferred_industries\\\",\\\"preferred_stock_types\\\",\\\"average_investment_amount\\\",\\\"trading_frequency\\\",\\\"holding_period\\\",\\\"historical_performance\\\",\\\"special_requirements\\\"],\\\"rows\\\":[[1264,41,\\\"Female\\\",\\\"low\\\",\\\"high\\\",\\\"long-term\\\",\\\"savings\\\",\\\"['healthcare']\\\",\\\"dividend\\\",5575.91,None,None,None,None]]}\"}</uc_function_result>\n\n**Hold**\n\nBased on the analysis of Tesla (TSLA) stock and the investment preferences of customer ID 1264, here's the detailed recommendation:\n\n1. **Current Market Price**: Tesla's current market price is $374.32, with a recent decline of about 1.02%. The stock has experienced a 52-week range between $138.8 and $488.54, indicating significant volatility.\n\n2. **Financial Insights**: Tesla is a leading manufacturer of electric vehicles and energy solutions. The company has a high market capitalization of approximately $1.2 trillion, with a trailing PE ratio of 185.31, which suggests that the stock is currently trading at a high valuation relative to its earnings.\n\n3. **Historical Performance**: Over the past year, Tesla's stock has shown considerable fluctuations, with a notable drop in January 2024. The average daily volume over the last three months is 88,742,310, indicating strong trading activity.\n\n4. **Customer Preferences**: Customer ID 1264 has a high-risk tolerance and a long-term investment horizon, with a preference for dividend stocks in the healthcare industry. While Tesla does not pay dividends and is not in the healthcare sector, its growth potential may align with the customer's high-risk tolerance.\n\nGiven the high valuation and recent market performance, along with the customer's preference for dividend stocks, a \"Hold\" recommendation is appropriate. This allows for monitoring Tesla's performance and market conditions, especially considering the customer's long-term investment horizon."
                },
                {
                    "role": "user",
                    "content": "should I invest in amazon stocks for customer id 6745?"
                },
                {
                    "role": "assistant",
                    "content": "I need to understand the specific investment preferences, risk tolerance, and other relevant details for customer ID 6745 to tailor the investment recommendation for Amazon stock accordingly.\n\n<uc_function_call>{\"id\":\"2Ii4Ge1Bpl7Phr1a1KMB\",\"name\":\"sarbanimaiti_catalog.agent_demo.cust_investment_pref\",\"arguments\":\"{\\\"customerID\\\":6745}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"2Ii4Ge1Bpl7Phr1a1KMB\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"customer_id\\\",\\\"age\\\",\\\"gender\\\",\\\"income_range\\\",\\\"risk_tolerance\\\",\\\"investment_horizon\\\",\\\"investment_goals\\\",\\\"preferred_industries\\\",\\\"preferred_stock_types\\\",\\\"average_investment_amount\\\",\\\"trading_frequency\\\",\\\"holding_period\\\",\\\"historical_performance\\\",\\\"special_requirements\\\"],\\\"rows\\\":[[6745,40,\\\"Female\\\",\\\"low\\\",\\\"high\\\",\\\"long-term\\\",\\\"savings\\\",\\\"['tech']\\\",\\\"blue-chip\\\",60018.1,None,None,None,None]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.get_hist_closing_price\n\n<uc_function_call>{\"id\":\"V7uprA79GK1CIlCadun6\",\"name\":\"sarbanimaiti_catalog.agent_demo.get_hist_closing_price\",\"arguments\":\"{\\\"stock_ticker\\\":\\\"AMZN\\\",\\\"yr_duration\\\":1}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"V7uprA79GK1CIlCadun6\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"Date\\\",\\\"Close\\\",\\\"Volume\\\"],\\\"rows\\\":[[\\\"2024-01-04\\\",144.57,56039800],[\\\"2024-01-05\\\",145.24,45124800],[\\\"2024-01-08\\\",149.1,46757100],[\\\"2024-01-09\\\",151.37,43812600],[\\\"2024-01-10\\\",153.73,44421800],[\\\"2024-01-11\\\",155.18,49072700],[\\\"2024-01-12\\\",154.62,40460300],[\\\"2024-01-16\\\",153.16,41384600],[\\\"2024-01-17\\\",151.71,34953400],[\\\"2024-01-18\\\",153.5,37850200],[\\\"2024-01-19\\\",155.34,51033700],[\\\"2024-01-22\\\",154.78,43687500],[\\\"2024-01-23\\\",156.02,37986000],[\\\"2024-01-24\\\",156.87,48547300],[\\\"2024-01-25\\\",157.75,43638600],[\\\"2024-01-26\\\",159.12,51047400],[\\\"2024-01-29\\\",161.26,45270400],[\\\"2024-01-30\\\",159.0,45207400]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_insight_api\n\n<uc_function_call>{\"id\":\"W0srfpMKpMNA7CEpCLhL\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_insight_api\",\"arguments\":\"{\\\"query\\\":\\\"AMZN\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"W0srfpMKpMNA7CEpCLhL\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"[\\\\\\\"Argus believes that 2025 may be defined by 10 investment themes. Throughout the year, we will take a deep dive into these themes, providing updates and giving stock picks on the prominent companies whose businesses play out in each theme. In many cases, we believe these thematic factors will supersede industry characteristics and drive performance. Our Investment Themes for 2025 are: Theme 1: Management Signals; Theme 2: Artificial Intelligence; Theme 3: Clean Energy; Theme 4: Sustainable Impact investing; Theme 5: Innovation; Theme 6: Cybersecurity; Theme 7: Investing in the Cloud; Theme 8: Aerospace and Defense, All Systems Go; Theme 9: Uptick in Capex amid Declining Interest Rates; and Theme 10: Pharmaceuticals and Biotechnology. For this week's Weekly List, we examine Theme 7: Investing in the Cloud. Cloud computing has transformed the technology landscape over the past decade. Created almost accidently as a means or organizing customer invoices, cloud has grown from the management of outsourced technology hardware resources to encompass tasks, up to and including software development, big data analytics, and artificial intelligence (AI). Indeed, following availability of ChatGPT in November 2022, awareness of generative AI hit the business community like an electric shock, and has completely upended IT spending plans for the next several years. Given that delivery of AI will mainly occur within a hybrid cloud environment, emergence of AI-as-a-service represents a difficult-to-quantify, but undoubtedly positive driver of cloud service revenues in the coming years. The leading providers of cloud services tend to be large technology and communications services companies that provide many goods and services distinct from or adjacent to their cloud businesses. These companies include Amazon.com, Microsoft, Alphabet, and others in the U.S., along with Alibaba, Baidu, Tencent, and others in China. Collectively, participants in the cloud eco-system grew revenue by a high-teens compound annual rate from 2016 to 2023. Revenue for cloud services has held up well, as cloud transition is a long-tailed process and cloud transformation has become an imperative. According to IDC, revenue in the industry grew 21% in 2024. Looking ahead, with inflation growth slowing and amid improving business and consumer confidence, both consumer device demand and enterprise IT spending should accelerate. We expect rising device demand and enterprise IT spending both domestically and internationally to drive cloud investment in 2025 and beyond. Some of the companies that should benefit in the space include the following.\\\\\\\"]\\\"]]}\"}</uc_function_result>\n\nI'm going to use sarbanimaiti_catalog.agent_demo.finance_stock_quote\n\n<uc_function_call>{\"id\":\"4Kg901Z2kHoSJER737Lo\",\"name\":\"sarbanimaiti_catalog.agent_demo.finance_stock_quote\",\"arguments\":\"{\\\"query\\\":\\\"AMZN\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"4Kg901Z2kHoSJER737Lo\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"output\\\"],\\\"rows\\\":[[\\\"{'quoteResponse': {'result': [{'language': 'en-US', 'region': 'US', 'quoteType': 'EQUITY', 'typeDisp': 'Equity', 'quoteSourceName': 'Nasdaq Real Time Price', 'triggerable': True, 'customPriceAlertConfidence': 'HIGH', 'currency': 'USD', 'hasPrePostMarketData': True, 'firstTradeDateMilliseconds': 863703000000, 'priceHint': 2, 'preMarketChange': -7.0, 'preMarketChangePercent': -2.930955, 'preMarketPrice': 231.83, 'regularMarketChange': 2.6600037, 'regularMarketDayHigh': 239.6599, 'regularMarketDayRange': '236.01 - 239.6599', 'regularMarketDayLow': 236.01, 'regularMarketVolume': 51116670, 'regularMarketPreviousClose': 236.17, 'bid': 238.62, 'ask': 238.82, 'bidSize': 2, 'askSize': 1, 'fullExchangeName': 'NasdaqGS', 'financialCurrency': 'USD', 'regularMarketOpen': 238.268, 'averageDailyVolume3Month': 36123216, 'averageDailyVolume10Day': 34331240, 'fiftyTwoWeekLowChange': 87.22, 'fiftyTwoWeekLowChangePercent': 0.5752919, 'fiftyTwoWeekRange': '151.61 - 242.52', 'fiftyTwoWeekHighChange': -3.6900024, 'fiftyTwoWeekHighChangePercent': -0.01521525, 'fiftyTwoWeekLow': 151.61, 'fiftyTwoWeekHigh': 242.52, 'fiftyTwoWeekChangePercent': 35.37977, 'earningsTimestamp': 1738875600, 'earningsTimestampStart': 1745837940, 'earningsTimestampEnd': 1746187200, 'earningsCallTimestampStart': 1738879200, 'earningsCallTimestampEnd': 1738879200, 'isEarningsDateEstimate': True, 'trailingAnnualDividendRate': 0.0, 'trailingPE': 43.110107, 'trailingAnnualDividendYield': 0.0, 'epsTrailingTwelveMonths': 5.54, 'epsForward': 6.15, 'epsCurrentYear': 6.25204, 'priceEpsCurrentYear': 38.200333, 'sharesOutstanding': 10515000320, 'bookValue': 24.655, 'fiftyDayAverage': 224.0106, 'fiftyDayAverageChange': 14.819397, 'fiftyDayAverageChangePercent': 0.06615489, 'twoHundredDayAverage': 195.25694, 'twoHundredDayAverageChange': 43.57306, 'twoHundredDayAverageChangePercent': 0.22315754, 'marketCap': 2511297576960, 'forwardPE': 38.834145, 'priceToBook': 9.686879, 'sourceInterval': 15, 'exchangeDataDelayedBy': 0, 'averageAnalystRating': '1.4 - Strong Buy', 'tradeable': False, 'cryptoTradeable': False, 'marketState': 'PRE', 'shortName': 'Amazon.com, Inc.', 'longName': 'Amazon.com, Inc.', 'corporateActions': [], 'preMarketTime': 1738925598, 'regularMarketTime': 1738875601, 'exchange': 'NMS', 'messageBoardId': 'finmb_18749', 'exchangeTimezoneName': 'America/New_York', 'exchangeTimezoneShortName': 'EST', 'gmtOffSetMilliseconds': -18000000, 'market': 'us_market', 'esgPopulated': False, 'regularMarketChangePercent': 1.1263089, 'regularMarketPrice': 238.83, 'displayName': 'Amazon.com', 'symbol': 'AMZN'}], 'error': None}}\\\"]]}\"}</uc_function_result>\n\n**Buy**\n\nBased on the analysis of Amazon (AMZN) stock and the investment preferences of customer ID 6745, here's the detailed recommendation:\n\n1. **Current Market Price**: Amazon's current market price is $238.83, with a recent increase of about 1.13%. The stock has experienced a 52-week range between $151.61 and $242.52, showing a strong upward trend with a 35.38% increase over the year.\n\n2. **Financial Insights**: Amazon is a leading player in the tech industry, particularly in cloud computing, which is expected to drive growth in the coming years. The company has a market capitalization of approximately $2.51 trillion, with a trailing PE ratio of 43.11, indicating a reasonable valuation for a tech giant.\n\n3. **Historical Performance**: Over the past year, Amazon's stock has shown consistent growth, with a strong performance in the tech sector. The average daily volume over the last three months is 36,123,216, reflecting robust trading activity.\n\n4. **Customer Preferences**: Customer ID 6745 has a high-risk tolerance and a long-term investment horizon, with a preference for blue-chip stocks in the tech industry. Amazon fits well within these preferences, offering growth potential and stability as a leading tech company.\n\nGiven the strong market position, growth prospects in cloud computing, and alignment with the customer's investment preferences, a \"Buy\" recommendation is appropriate. This allows the customer to capitalize on Amazon's growth potential in the tech sector, particularly in cloud services and AI."
                },
                {
                    "role": "user",
                    "content": "What are the current market price, market capitalization, and recent performance of Amazon stock?"
                },
                {
                    "role": "assistant",
                    "content": "Here are the details for Amazon (AMZN) stock:\n\n1. **Current Market Price**: $238.83\n\n2. **Market Capitalization**: Approximately $2.51 trillion\n\n3. **Recent Performance**: \n   - The stock has experienced a 52-week range between $151.61 and $242.52.\n   - It has shown a strong upward trend with a 35.38% increase over the year.\n   - The recent market change was an increase of about 1.13%.\n\nThese figures reflect Amazon's strong position in the market and its consistent growth, particularly in the tech sector."
                },
                {
                    "role": "user",
                    "content": "thank you"
                }
            ]
        },
        "expected_response": None
    }
]

eval_dataset = pd.DataFrame(eval_examples)
display(eval_dataset)

# COMMAND ----------

import mlflow
import pandas as pd

with mlflow.start_run(run_id=logged_agent_info.run_id):
    eval_results = mlflow.evaluate(
        f"runs:/{logged_agent_info.run_id}/agent",  # replace `chain` with artifact_path that you used when calling log_model.
        data=eval_dataset,  # Your evaluation dataset
        model_type="databricks-agent",  # Enable Mosaic AI Agent Evaluation
    )

# Review the evaluation results in the MLFLow UI (see console output), or access them in place:
display(eval_results.tables['eval_results'])

# COMMAND ----------

# MAGIC %md
# MAGIC ## Register the model to Unity Catalog
# MAGIC
# MAGIC Update the `catalog`, `schema`, and `model_name` below to register the MLflow model to Unity Catalog.

# COMMAND ----------

mlflow.set_registry_uri("databricks-uc")

# TODO: define the catalog, schema, and model name for your UC model
catalog = "sarbanimaiti_catalog"
schema = "agent_demo"
model_name = "investment-assistant-v5"
UC_MODEL_NAME = f"{catalog}.{schema}.{model_name}"

# register the model to UC
uc_registered_model_info = mlflow.register_model(model_uri=logged_agent_info.model_uri, name=UC_MODEL_NAME)

# COMMAND ----------

# MAGIC %md
# MAGIC ## Deploy the agent

# COMMAND ----------

from databricks import agents

# Deploy the model to the review app and a model serving endpoint
agents.deploy(UC_MODEL_NAME, uc_registered_model_info.version, tags = {"endpointSource": "playground"})
